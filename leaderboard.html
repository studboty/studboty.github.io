<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Leaderboard</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="./js/launchfirebase.js"></script>
  <style>
    body {
      background: #0e1117;
      color: #e6edf3;
      font-family: system-ui, sans-serif;
      padding: 30px;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #c9d1d9;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: auto;
      font-size: 1em;
    }

    th,
    td {
      padding: 12px;
      border-bottom: 1px solid #30363d;
      text-align: left;
    }

    th {
      background: #1f262e;
      color: #c9d1d9;
    }

    tr:hover {
      background: #222a36;
    }

    .profile-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
      vertical-align: middle;
    }

    .rank {
      font-weight: bold;
      color: #58a6ff;
    }

    @media(max-width:600px) {

      th,
      td {
        padding: 8px;
        font-size: 0.9em;
      }

      .profile-icon {
        width: 30px;
        height: 30px;
      }
    }


    nav {
      background: #161b22;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      border-bottom: 1px solid #30363d;
    }

    nav h3 {
      cursor: pointer;
      font-size: 1.5em;
      color: #fff;
    }

    nav img {
      height: 32px;
      cursor: pointer;
      margin-left: 12px;
    }
  </style>
</head>

<body>

  <h1>Leaderboard</h1>
  <table>
    <thead>
      <nav>
        <div id='nav-left'>

        </div>
        <div id="nav-right">
          <img src="images/panic.png" alt="Panic Button" id="panic-button"
            onclick="window.location.href='https://classroom.google.com'" title="Panic Button - Go to Google">
          <img src="images/chat.png" alt="Chat" id="chat-button"
            onclick="window.location.href='https://lolfactor39.github.io/chat/'"
            title="Chat with firends like discord!">

        </div>
      </nav>
      <script src="js/uttils.js"></script>
      <script src="js/user.js"></script>
      <script>

        const admin = new URLSearchParams(window.location.search).get('admin');
        const accescode = new URLSearchParams(window.location.search).get('frees');
        const navLeft = document.getElementById('nav-left');
        const navRight = document.getElementById('nav-right');

        function createNavTitle(text, href) {
          const h3 = document.createElement('h3');
          h3.textContent = text;
          h3.style.cursor = 'pointer';
          h3.onclick = () => window.location.href = href;
          return h3;
        }

        if (admin === 'True') {
          // Admin title on left
          navLeft.appendChild(createNavTitle('Gamer Hubs - Admin', './games.html?admin=True'));
          const adminTable = createNavTitle('Admin Table', './adtable.html');
          navRight.appendChild(adminTable);

          document.title = 'Gamer Hubs - Admin';
        }
        if (accescode === 'true') {
          navLeft.appendChild(createNavTitle('Gamer HUBS - Free Enabled ', './games.html?free=True'));
          document.title = 'Gamer Hubs - Free Access';
          //The fun - Main code
          sessionStorage.setItem('freeAccess', 'true');
        }
        else if (admin === "False") {
          navLeft.appendChild(createNavTitle('Gamer HUBS', './games.html?admin=False'));
          document.title = 'Studying';
          let uids = sessionStorage.getItem('uid');
          console.log(uids);
          window.trackUserOnlineStatus(uids);
          window.trackUser(uids);
        }
        if (accescode == "False") {
          navLeft.appendChild(createNavTitle('Gamer HUBS', './games.html'));
          document.title = 'Studying';
          let uids = sessionStorage.getItem('uid');
          console.log(uids);
          window.trackUserOnlineStatus(uids);
          window.trackUser(uids);
        }
      </script>
      <tr>
        <th>#</th>
        <th>Profile</th>
        <th>Name / Email</th>
        <th>Time Spent</th>
      </tr>
    </thead>
    <tbody id="leaderboard"></tbody>
  </table>

  <script>
    const leaderboard = document.getElementById("leaderboard");

    firebase.database().ref("users").on("value", snap => {
      const data = snap.val() || {};
      const users = Object.values(data)
        .filter(u => !u.banned) // only show non-banned users
        .sort((a, b) => (b.timeSpent || 0) - (a.timeSpent || 0));

      leaderboard.innerHTML = "";
      users.forEach((u, idx) => {
        const icon = u.icon || "https://www.encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQRMxQNpli6ElVRQIZEVFxHK10jxx2LYteBebsjQLO2IK8PG7dFJ2Ix-Fr8t8uFW8m4JgG9blzHwcvuymWUKCW46tVFBvVpx5EMFUqibw&s=10";
        const seconds = u.timeSpent || 0;
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = seconds % 60;
        const timeStr = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;

        const row = document.createElement("tr");
        row.innerHTML = `
      <td class="rank">#${idx + 1}</td>
      <td><img class="profile-icon" src="${icon}"></td>
      <td>${u.name || u.email}</td>
      <td>${timeStr}</td>
    `;
        leaderboard.appendChild(row);
      });
    });
  </script>

</body>

</html>