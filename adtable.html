<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="./js/launchfirebase.js"></script>
<script src="./js/user.js"></script>

<style>
* { box-sizing:border-box; margin:0; padding:0; }
body { font-family:system-ui, sans-serif; background:#0e1117; color:#e6edf3; padding-top:70px; }
nav { background:#161b22; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; position:fixed; top:0; left:0; right:0; z-index:100; border-bottom:1px solid #30363d; }
nav h3 { cursor:pointer; font-size:1.5em; color:#fff; }
nav img { height:32px; cursor:pointer; margin-left:12px; }

#adminApp { max-width:1500px; margin:30px auto; background:#161b22; padding:20px 25px; border-radius:12px; box-shadow:0 15px 40px #0008; }
h1 { text-align:center; margin-bottom:15px; color:#c9d1d9; }

#search { width:100%; padding:10px; border-radius:8px; border:1px solid #30363d; background:#0e1117; color:#fff; margin-bottom:20px; font-size:1em; }

table { width:100%; border-collapse:collapse; font-size:0.95em; }
th, td { padding:12px; border-bottom:1px solid #30363d; text-align:left; vertical-align:middle; }
th { background:#1f262e; color:#c9d1d9; }
tr:hover { background:#222a36; }

button { border:none; border-radius:6px; padding:6px 12px; cursor:pointer; font-weight:bold; font-size:0.85em; transition:0.2s; }
button.danger { background:#da3633; color:white; }
button.danger:hover { background:#ff4c42; }
button.normal { background:#238636; color:white; }
button.normal:hover { background:#2ea043; }

.profile-icon { width:40px; height:40px; border-radius:50%; margin-right:8px; vertical-align:middle; }
.rank { font-weight:bold; color:#58a6ff; }

@media(max-width:600px){ #adminApp { padding:15px; } th,td{padding:8px;font-size:0.85em;} nav h3{font-size:1.2em;} .profile-icon{width:30px;height:30px;} }
</style>
</head>
<body>

<nav>
  <div id ='nav-left'>

  </div>
  <div id="nav-right">
    <img src="images/panic.png" alt="Panic" title="Panic Button" onclick="window.location.href='https://classroom.google.com'">
    <img src="images/chat.png" alt="Chat" title="Chat" onclick="window.location.href='https://lolfactor39.github.io/chat/'">
  </div>
</nav>

<div id="adminApp">
  <h1>Admin Control Panel</h1>
  <input id="search" placeholder="Search by email...">
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Profile</th>
        <th>Email</th>
        <th>Role</th>
        <th>Name</th>
        <th>Time Spent</th>
        <th>Online</th>
        <th>Leaderboard Ban</th>
        <th>Controls</th>
      </tr>
    </thead>
    <tbody id="adminTable"></tbody>
  </table>
</div>
<script src="./js/user.js"></script>
<script src="js/uttils.js"></script>
<script>
const OWNER_EMAIL = ["advikmurthy12@gmail.com","664904@stu.sandi.net"];
const table = document.getElementById("adminTable");
const search = document.getElementById("search");
const navLeft = document.getElementById("nav-left");
const navRight = document.getElementById("nav-right")
let cache = {};


function createNavTitle(text, href) {
        const h3 = document.createElement('h3');
        h3.textContent = text;
        h3.style.cursor = 'pointer';
        h3.onclick = () => window.location.href = href;
        return h3;
      }

if (sessionStorage.getItem("freeAccess") == "true") {
  navLeft.appendChild(createNavTitle("Gammer HUBS - Admin", "./games.html?free=True"));
  navRight.appendChild(createNavTitle('Leaderboard', './leaderboard.html?frees=True'));
}
if (sessionStorage.getItem("isAdmin") == "true") {
  navLeft.appendChild(createNavTitle("Gammer HUBS - Admin", "./games.html?admin=True"));
  navRight.appendChild(createNavTitle('Leaderboard', './leaderboard.html?frees=true'));
}


// Listen for users in Firebase
firebase.database().ref("users").on("value", snap => {
  cache = snap.val() || {};
  renderTable();
});

search.oninput = renderTable;

// Render the admin table
function renderTable() {
  const q = search.value.toLowerCase();
  table.innerHTML = "";

  const users = Object.entries(cache)
                      .filter(([uid,u]) => u.email.toLowerCase().includes(q))
                      .sort((a,b) => (b[1].timeSpent||0) - (a[1].timeSpent||0));

  users.forEach(([uid,u], idx) => {
    const isOwner = OWNER_EMAIL.some(email => u.email.toLowerCase() === email.toLowerCase());
    const icon = u.icon || "https://www.encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQRMxQNpli6ElVRQIZEVFxHK10jxx2LYteBebsjQLO2IK8PG7dFJ2Ix-Fr8t8uFW8m4JgG9blzHwcvuymWUKCW46tVFBvVpx5EMFUqibw&s=10";

    const seconds = u.timeSpent || 0;
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    const online = u.online ? "Yes" : "No";
    const name = u.name || "N/A";
    const timeStr = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;

    const leaderboardBanText = u.banned ? "Unban" : "Ban";

    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="rank">#${idx+1}</td>
      <td><img class="profile-icon" src="${icon}"></td>
      <td>${u.email}</td>
      <td>${u.role}${isOwner?" (Owner)":""}</td>
      <td>${name}</td>
      <td>${timeStr}</td>
      <td>${online}</td>
      <td><button class="normal" data-action="leaderboardBan" data-uid="${uid}" ${isOwner?"disabled":""}>${leaderboardBanText}</button></td>
      <td>
        <button class="danger" data-action="ban" data-uid="${uid}" ${isOwner?"disabled":""}>Ban</button>
        <button class="normal" data-action="unban" data-uid="${uid}" ${isOwner?"disabled":""}>Unban</button>
        <button class="normal" data-action="makeadmin" data-uid="${uid}" ${isOwner?"disabled":""}>Make Admin</button>
      </td>
    `;
    table.appendChild(row);
  });
}

// Handle control buttons
table.onclick = function(e){
  const btn = e.target;
  const uid = btn.dataset.uid;
  if(!uid) return;
  const user = cache[uid];
  if(!user) return;
  const isOwner = user.email.toLowerCase() === OWNER_EMAIL;
  if(isOwner) return;

  const action = btn.dataset.action;

  if(action === "ban") window.editUserProp(uid,"role","blocked");
  if(action === "unban") window.editUserProp(uid,"role","user");
  if(action === "makeadmin") window.editUserProp(uid,"role","admin");
  if(action === "leaderboardBan") {
    window.editUserProp(uid,"banned", !user.banned);
  }
};
</script>
</body>
</html>
